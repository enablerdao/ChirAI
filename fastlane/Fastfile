# Fastlane è‡ªå‹•åŒ–è¨­å®š

default_platform(:ios)

platform :ios do
  
  # é–‹ç™ºå‰ã®æº–å‚™
  before_all do
    ensure_git_status_clean
    git_pull
    cocoapods if File.exist?("Podfile")
  end

  # TestFlight è‡ªå‹•é…å¸ƒ
  desc "ğŸš€ TestFlight ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤"
  lane :beta do
    # ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è‡ªå‹•å¢—åŠ 
    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )
    
    # è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæœŸ
    match(type: "appstore")
    
    # ãƒ“ãƒ«ãƒ‰
    build_app(
      scheme: "ChirAI",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.enablerdao.ChirAI" => "match AppStore com.enablerdao.ChirAI"
        }
      }
    )
    
    # TestFlight ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      changelog: last_git_commit[:message]
    )
    
    # Slack é€šçŸ¥
    slack(
      message: "ğŸš€ ChirAI ãŒTestFlightã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼",
      channel: "#ios-releases",
      success: true
    )
  end

  # App Store ãƒªãƒªãƒ¼ã‚¹
  desc "ğŸ App Store ã«è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹"
  lane :release do |options|
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨­å®š
    increment_version_number(
      version_number: options[:version]
    )
    
    # ãƒ“ãƒ«ãƒ‰
    build_app(
      scheme: "ChirAI",
      export_method: "app-store"
    )
    
    # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæº–å‚™
    capture_screenshots
    
    # App Store ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_app_store(
      force: true,
      automatic_release: true,
      submit_for_review: true,
      
      # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
      app_identifier: "com.enablerdao.ChirAI",
      
      name: {
        "ja" => "ChirAI - ãƒ­ãƒ¼ã‚«ãƒ«AIãƒãƒ£ãƒƒãƒˆ",
        "en-US" => "ChirAI - Local AI Chat"
      },
      
      subtitle: {
        "ja" => "ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒ­ãƒ¼ã‚«ãƒ«AIãƒãƒ£ãƒƒãƒˆ",
        "en-US" => "Intelligent Local AI Chat"
      },
      
      description: {
        "ja" => File.read("./metadata/ja/description.txt"),
        "en-US" => File.read("./metadata/en-US/description.txt")
      },
      
      keywords: {
        "ja" => "AI,ãƒãƒ£ãƒƒãƒˆ,ãƒ­ãƒ¼ã‚«ãƒ«,ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼,ollama,æ—¥æœ¬èª,LLM,ä¼šè©±,æ¡œ,æ©Ÿæ¢°å­¦ç¿’",
        "en-US" => "AI,chat,local,privacy,ollama,japanese,LLM,conversation,sakura,machine learning"
      },
      
      # ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼
      privacy_url: {
        "ja" => "https://github.com/enablerdao/ChirAI/blob/main/PRIVACY_POLICY_GDPR_COMPLIANT.md",
        "en-US" => "https://github.com/enablerdao/ChirAI/blob/main/PRIVACY_POLICY_GDPR_COMPLIANT.md"
      },
      
      # å¯©æŸ»æƒ…å ±
      app_review_information: {
        first_name: "ChirAI",
        last_name: "Team",
        phone_number: "+81-90-0000-0000",
        email_address: "review@enablerdao.com",
        demo_user: "",
        demo_password: "",
        notes: "This app requires Ollama (https://ollama.ai) to be installed locally. All AI processing happens on device."
      }
    )
    
    # ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥
    slack(
      message: "ğŸ‰ ChirAI v#{options[:version]} ãŒ App Store ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸï¼",
      channel: "#ios-releases",
      success: true
    )
  end

  # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè‡ªå‹•ç”Ÿæˆ
  desc "ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè‡ªå‹•ç”Ÿæˆ"
  lane :screenshots do
    capture_screenshots(
      workspace: "ChirAI.xcworkspace",
      scheme: "ChirAI-UITests",
      output_directory: "./screenshots",
      clear_previous_screenshots: true,
      
      devices: [
        "iPhone 15 Pro",
        "iPhone 15 Plus", 
        "iPhone 8 Plus",
        "iPad Pro (12.9-inch) (6th generation)"
      ],
      
      languages: ["ja", "en-US"],
      
      override_status_bar: true,
      
      # ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¨­å®š
      screenshot_config: {
        "ja" => {
          "chat" => "ãƒãƒ£ãƒƒãƒˆç”»é¢",
          "agents" => "AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ",
          "settings" => "è¨­å®š"
        },
        "en-US" => {
          "chat" => "Chat Interface",
          "agents" => "AI Agents",
          "settings" => "Settings"
        }
      }
    )
    
    # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒ•ãƒ¬ãƒ¼ãƒ ä»˜ãã§åŠ å·¥
    frame_screenshots(
      silver: false,
      path: "./screenshots"
    )
  end

  # ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
  error do |lane, exception|
    slack(
      message: "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: #{exception.message}",
      channel: "#ios-releases",
      success: false
    )
  end
  
  # æˆåŠŸå¾Œã®å‡¦ç†
  after_all do |lane|
    # Git ã‚¿ã‚°ã‚’ä½œæˆ
    if lane == :release
      add_git_tag(
        tag: "release/#{get_version_number}"
      )
      push_git_tags
    end
    
    # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    clean_build_artifacts
  end
end