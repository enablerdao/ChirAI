name: ğŸš€ Auto Deploy to App Store

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    types: [closed]
    branches:
      - main

env:
  XCODE_VERSION: "15.0"
  PROJECT_NAME: "ChirAI"
  SCHEME_NAME: "ChirAI"
  BUNDLE_ID: "com.enablerdao.ChirAI"

jobs:
  # è‡ªå‹•ãƒ†ã‚¹ãƒˆ
  test:
    name: ğŸ§ª è‡ªå‹•ãƒ†ã‚¹ãƒˆ
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Run Tests
        run: |
          if [ -f "quick_e2e_test.swift" ]; then
            swift quick_e2e_test.swift
          fi

  # è‡ªå‹•ãƒ“ãƒ«ãƒ‰ & TestFlighté…å¸ƒ
  deploy-testflight:
    name: ğŸ¯ TestFlight è‡ªå‹•é…å¸ƒ
    runs-on: macos-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: Install Fastlane
        run: |
          gem install fastlane
          
      - name: è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_KEYCHAIN_NAME: ${{ secrets.MATCH_KEYCHAIN_NAME }}
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
        run: |
          # Keychainä½œæˆ
          security create-keychain -p "$MATCH_KEYCHAIN_PASSWORD" "$MATCH_KEYCHAIN_NAME"
          security default-keychain -s "$MATCH_KEYCHAIN_NAME"
          security unlock-keychain -p "$MATCH_KEYCHAIN_PASSWORD" "$MATCH_KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$MATCH_KEYCHAIN_NAME"
          
      - name: Fastlane Match (è¨¼æ˜æ›¸åŒæœŸ)
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        run: |
          fastlane match appstore --readonly

      - name: ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è‡ªå‹•å¢—åŠ 
        run: |
          BUILD_NUMBER=$(date +%Y%m%d%H%M)
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" ChirAI/Info.plist

      - name: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
        run: |
          xcodebuild archive \
            -project ChirAI.xcodeproj \
            -scheme ${{ env.SCHEME_NAME }} \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath ChirAI.xcarchive \
            DEVELOPMENT_TEAM=${{ secrets.TEAM_ID }} \
            PRODUCT_BUNDLE_IDENTIFIER=${{ env.BUNDLE_ID }}

      - name: IPA ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        run: |
          xcodebuild -exportArchive \
            -archivePath ChirAI.xcarchive \
            -exportPath . \
            -exportOptionsPlist exportOptions.plist

      - name: TestFlight ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        env:
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
          FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        run: |
          fastlane pilot upload \
            --ipa ChirAI.ipa \
            --skip_waiting_for_build_processing \
            --changelog "$(git log -1 --pretty=%B)"

      - name: Slack é€šçŸ¥
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ğŸš€ ChirAI TestFlight é…å¸ƒ: ${{ job.status }}
            ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
            ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # App Store è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ (ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥æ™‚)
  deploy-appstore:
    name: ğŸ App Store è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹
    runs-on: macos-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Install Fastlane
        run: gem install fastlane

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: App Store ãƒªãƒªãƒ¼ã‚¹
        env:
          FASTLANE_USER: ${{ secrets.APPLE_ID }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.ASC_API_KEY }}
        run: |
          fastlane release version:${{ steps.version.outputs.VERSION }}

  # è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç”Ÿæˆ
  screenshots:
    name: ğŸ“¸ è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
    runs-on: macos-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Simulator
        run: |
          xcrun simctl boot "iPhone 15 Pro" || true
          
      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç”Ÿæˆ
        run: |
          python3 generate_real_screenshots.py
          
      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚³ãƒŸãƒƒãƒˆ
        uses: EndBug/add-and-commit@v9
        with:
          add: 'screenshots/'
          message: 'ğŸ“¸ Auto-generated screenshots'
          default_author: github_actions

  # ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹è‡ªå‹•ç”Ÿæˆ
  release-notes:
    name: ğŸ“ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
        uses: release-drafter/release-drafter@v5
        with:
          config-name: release-drafter.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Twitter è‡ªå‹•æŠ•ç¨¿
        uses: ethomson/send-tweet-action@v1
        with:
          status: |
            ğŸŒ¸ ChirAI ${{ github.ref_name }} ãƒªãƒªãƒ¼ã‚¹ï¼
            
            âœ¨ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦–ã®ãƒ­ãƒ¼ã‚«ãƒ«AIãƒãƒ£ãƒƒãƒˆ
            ğŸ¤– 14ç¨®é¡ã®AIãƒ¢ãƒ‡ãƒ«å¯¾å¿œ
            ğŸ‡¯ğŸ‡µ å®Œç’§ãªæ—¥æœ¬èªã‚µãƒãƒ¼ãƒˆ
            
            App Store: https://apps.apple.com/app/chirai
            GitHub: https://github.com/enablerdao/ChirAI
            
            #ChirAI #AI #iOS #Privacy
          consumer-key: ${{ secrets.TWITTER_CONSUMER_KEY }}
          consumer-secret: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          access-token: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          access-token-secret: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}